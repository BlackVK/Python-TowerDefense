<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Tower Defense ‚Äî Python Control</title>
<link rel="icon" href="icon.png" type="image/png">
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
:root {
  --bg: #061018;
  --panel: #0b1620;
  --muted: #9fb0c2;
  --blue: #00c2ff;
  --green: #2ef27b;
  --red: #ff6b6b;
  --yellow: #ffd166;
  --purple: #c084fc;
  --glass: rgba(255,255,255,0.03);
  --font: 'Inter', system-ui, sans-serif;
}
* { box-sizing: border-box; margin:0; padding:0; }
html, body { height:100%; }
body { font-family: var(--font); background: var(--bg); color:#dbeafe; display:flex; overflow:hidden; }
.container { display:flex; flex:1; height:100vh; padding:18px; gap:18px; }
.left { flex:0 0 60%; background:linear-gradient(180deg,rgba(255,255,255,0.02),transparent); border-radius:12px; padding:16px; display:flex; flex-direction:column; gap:12px; box-shadow:0 6px 40px rgba(0,0,0,0.6); border:1px solid rgba(255,255,255,0.03); position:relative;}
.panel-title { display:flex; justify-content:space-between; align-items:center; }
h1 { margin:0; font-size:18px; color:var(--blue); letter-spacing:0.6px; }
.chip { background: rgba(255,255,255,0.02); padding:6px 8px; border-radius:999px; border:1px solid rgba(255,255,255,0.03); color:var(--muted); font-size:13px; }
#gameWrap { flex:1; display:flex; align-items:center; justify-content:center; position:relative; overflow:hidden; }
canvas#gameCanvas { width:100%; height:100%; border-radius:10px; background:linear-gradient(180deg,#081522,#06121a); box-shadow:inset 0 0 80px rgba(0,0,0,0.25); border:1px solid rgba(255,255,255,0.02); }
.controls-row { display:flex; gap:8px; align-items:center; margin-top:8px; }
.btn { background: var(--glass); border:1px solid rgba(255,255,255,0.04); color:var(--blue); padding:8px 12px; border-radius:8px; cursor:pointer; font-weight:700; font-size:13px; transition: all 0.3s ease; }
.btn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,194,255,0.3); }
.btn.secondary { color:var(--green); }
.btn.danger { color:var(--red); }
.small { padding:6px 8px; font-size:12px; }
.right { flex:0 0 40%; display:flex; flex-direction:column; gap:12px; }
.card { background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); border-radius:10px; padding:12px; border:1px solid rgba(255,255,255,0.03); box-shadow:0 6px 20px rgba(0,0,0,0.6); }
.editor-wrap { height:48vh; display:flex; flex-direction:column; }
.tabs { display:flex; gap:8px; margin-bottom:8px; }
.tab { padding:8px 12px; border-radius:8px; cursor:pointer; color:var(--muted); background:transparent; border:1px solid transparent; font-size:13px; transition: all 0.3s ease; }
.tab.active { color:#fff; background:linear-gradient(90deg, rgba(0,194,255,0.06), rgba(46,242,123,0.03)); border:1px solid rgba(255,255,255,0.03); box-shadow:0 6px 20px rgba(0,0,0,0.5);}
#editor { flex:1; border-radius:8px; overflow:hidden; min-height:0; }

/* –°—Ç–∏–ª–∏ –¥–ª—è CodeMirror */
.CodeMirror {
  height: 100% !important;
  font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
  font-size: 14px;
  line-height: 1.5;
  background: #041018 !important;
}

.CodeMirror-gutters {
  background: #06121a !important;
  border-right: 1px solid rgba(255,255,255,0.05) !important;
  width: 50px !important;
}

.CodeMirror-linenumber {
  color: var(--muted) !important;
  padding: 0 10px 0 5px !important;
  min-width: 30px !important;
  text-align: right !important;
}

.CodeMirror-lines {
  padding-left: 10px !important;
}

.CodeMirror-cursor {
  border-left: 2px solid var(--blue) !important;
}

.CodeMirror-selected {
  background: rgba(0,194,255,0.1) !important;
}

.CodeMirror-line {
  padding-left: 10px !important;
}

#guidePanel { 
  flex:1; 
  background:#041018; 
  border-radius:8px; 
  padding:16px; 
  overflow:auto; 
  color:var(--muted); 
  font-size:13px; 
  line-height:1.5;
  display: none;
}
#guidePanel.active {
  display: block;
}
#console { height:30vh; background:#041018; border-radius:8px; padding:8px; overflow:auto; color:var(--muted); font-family:monospace; font-size:13px; white-space:pre-wrap; }
.footer-row { display:flex; justify-content:space-between; align-items:center; gap:8px; margin-top:8px; }
.hint { font-size:12px; color:var(--muted); }
.neon-badge { background: linear-gradient(90deg, var(--blue), var(--green)); color:#001018; padding:6px 10px; border-radius:999px; font-weight:800; font-size:12px; }
.guide-content code {
  background: rgba(0,194,255,0.1);
  padding: 2px 6px;
  border-radius: 4px;
  color: var(--blue);
  font-family: monospace;
}
.guide-content pre {
  background: rgba(0,194,255,0.05);
  padding: 12px;
  border-radius: 6px;
  margin: 8px 0;
  border-left: 3px solid var(--blue);
  overflow-x: auto;
}
.guide-content ul {
  margin: 8px 0;
  padding-left: 20px;
}
.guide-content li {
  margin: 4px 0;
}
.guide-content h3 {
  color: var(--blue);
  margin: 16px 0 8px 0;
  font-size: 14px;
}
.guide-content h4 {
  color: var(--green);
  margin: 12px 0 6px 0;
  font-size: 13px;
}

/* Game Over Overlay */
#gameOver {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(6, 16, 24, 0.95);
  display: none;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  z-index: 1000;
  border-radius: 10px;
}

.game-over-text {
  font-size: 72px;
  font-weight: 900;
  color: transparent;
  background: linear-gradient(45deg, var(--red), var(--yellow), var(--purple), var(--blue));
  background-size: 400% 400%;
  -webkit-background-clip: text;
  background-clip: text;
  animation: gradientShift 3s ease infinite;
  text-shadow: 0 0 30px rgba(255, 107, 107, 0.5);
  margin-bottom: 20px;
}

.game-over-subtext {
  font-size: 24px;
  color: var(--muted);
  margin-bottom: 30px;
  text-align: center;
}

.game-over-stats {
  background: rgba(255,255,255,0.05);
  padding: 20px;
  border-radius: 10px;
  margin-bottom: 30px;
  text-align: center;
}

.game-over-stats div {
  margin: 8px 0;
  font-size: 16px;
}

/* Ruler */
#ruler {
  position: absolute;
  top: 10px;
  left: 10px;
  background: rgba(0, 0, 0, 0.7);
  border: 1px solid rgba(255,255,255,0.2);
  border-radius: 6px;
  padding: 8px;
  z-index: 100;
  font-size: 11px;
  font-family: monospace;
  color: var(--muted);
  backdrop-filter: blur(10px);
}

.ruler-toggle {
  position: absolute;
  top: 10px;
  right: 10px;
  z-index: 101;
}

.coordinates {
  margin-top: 4px;
  font-size: 10px;
}

@keyframes gradientShift {
  0% { background-position: 0% 50%; }
  50% { background-position: 100% 50%; }
  100% { background-position: 0% 50%; }
}

@keyframes pulse {
  0% { transform: scale(1); }
  50% { transform: scale(1.05); }
  100% { transform: scale(1); }
}

.pulse {
  animation: pulse 2s infinite;
}

/* === –ù–û–í–´–ï –°–¢–ò–õ–ò –î–õ–Ø –°–ò–°–¢–ï–ú–´ –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–ï–ô === */
#mainMenu {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: linear-gradient(135deg, #061018, #0a1725);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 2000;
  backdrop-filter: blur(10px);
}

.menu-container {
  width: 90%;
  max-width: 500px;
  background: var(--panel);
  border-radius: 16px;
  padding: 30px;
  border: 1px solid rgba(255,255,255,0.05);
  box-shadow: 0 20px 60px rgba(0,0,0,0.8);
}

.menu-section {
  display: none;
}

.menu-section.active {
  display: block;
}

.menu-title {
  text-align: center;
  margin-bottom: 30px;
  color: var(--blue);
  font-size: 28px;
  font-weight: 800;
}

.menu-subtitle {
  text-align: center;
  color: var(--muted);
  margin-bottom: 25px;
  font-size: 14px;
}

.input-group {
  margin-bottom: 15px;
}

.input-group input {
  width: 100%;
  padding: 12px 16px;
  background: rgba(255,255,255,0.05);
  border: 1px solid rgba(255,255,255,0.1);
  border-radius: 8px;
  color: white;
  font-size: 14px;
  transition: all 0.3s;
}

.input-group input:focus {
  outline: none;
  border-color: var(--blue);
  box-shadow: 0 0 0 2px rgba(0,194,255,0.2);
}

.btn-menu {
  width: 100%;
  padding: 14px;
  background: linear-gradient(90deg, var(--blue), var(--green));
  border: none;
  border-radius: 8px;
  color: #001018;
  font-weight: 700;
  font-size: 16px;
  cursor: pointer;
  margin: 10px 0;
  transition: transform 0.3s;
}

.btn-menu:hover {
  transform: translateY(-2px);
}

.btn-secondary {
  background: transparent;
  border: 2px solid var(--blue);
  color: var(--blue);
}

.menu-switch {
  text-align: center;
  margin-top: 20px;
  color: var(--muted);
  font-size: 13px;
}

.menu-switch a {
  color: var(--blue);
  cursor: pointer;
  text-decoration: none;
  font-weight: 600;
}

.user-info {
  background: rgba(0,194,255,0.1);
  padding: 15px;
  border-radius: 10px;
  margin-bottom: 20px;
  text-align: center;
}

.user-info h3 {
  color: var(--green);
  margin-bottom: 10px;
}

.user-stats {
  display: flex;
  justify-content: space-around;
  margin-top: 10px;
  font-size: 12px;
}

.stat-item {
  text-align: center;
}

.stat-value {
  display: block;
  font-size: 18px;
  font-weight: 700;
  color: var(--blue);
}

.map-selection {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 15px;
  margin: 20px 0;
}

.map-card {
  background: rgba(255,255,255,0.03);
  border-radius: 10px;
  padding: 15px;
  border: 1px solid rgba(255,255,255,0.05);
  cursor: pointer;
  transition: all 0.3s;
}

.map-card:hover {
  border-color: var(--blue);
  transform: translateY(-3px);
  background: rgba(0,194,255,0.05);
}

.map-card.selected {
  border-color: var(--green);
  background: rgba(46,242,123,0.05);
}

.map-card.locked {
  opacity: 0.5;
  cursor: not-allowed;
  position: relative;
}

.map-card.locked::after {
  content: 'üîí';
  position: absolute;
  top: 10px;
  right: 10px;
  font-size: 20px;
}

.map-card h4 {
  color: var(--blue);
  margin-bottom: 5px;
}

.map-difficulty {
  font-size: 11px;
  padding: 3px 8px;
  border-radius: 10px;
  background: rgba(255,255,255,0.1);
  display: inline-block;
  margin-bottom: 10px;
}

.map-record {
  font-size: 11px;
  color: var(--green);
  margin-top: 5px;
}

.level-description {
  background: rgba(0,194,255,0.05);
  border-left: 3px solid var(--blue);
  padding: 15px;
  border-radius: 8px;
  margin: 20px 0;
  font-size: 14px;
  line-height: 1.5;
}

.leaderboard-container {
  max-height: 300px;
  overflow-y: auto;
  margin-top: 20px;
}

.leaderboard-table {
  width: 100%;
  border-collapse: collapse;
}

.leaderboard-table th {
  text-align: left;
  padding: 10px;
  background: rgba(0,194,255,0.1);
  color: var(--blue);
  font-size: 12px;
}

.leaderboard-table td {
  padding: 10px;
  border-bottom: 1px solid rgba(255,255,255,0.05);
  font-size: 13px;
}

.leaderboard-table tr:nth-child(even) {
  background: rgba(255,255,255,0.02);
}

.rank-1 { color: #FFD700; font-weight: bold; }
.rank-2 { color: #C0C0C0; font-weight: bold; }
.rank-3 { color: #CD7F32; font-weight: bold; }

#leaderboardMapSelect {
  width: 100%;
  padding: 10px;
  background: rgba(255,255,255,0.05);
  border: 1px solid rgba(255,255,255,0.1);
  border-radius: 8px;
  color: white;
  font-size: 14px;
  margin-bottom: 15px;
}

/* –≠–∫—Ä–∞–Ω –æ–ø–∏—Å–∞–Ω–∏—è —É—Ä–æ–≤–Ω—è */
#levelDescription {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(6, 16, 24, 0.95);
  display: none;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  z-index: 1001;
  border-radius: 10px;
}

.level-description-content {
  background: var(--panel);
  border-radius: 16px;
  padding: 30px;
  max-width: 600px;
  width: 90%;
  border: 1px solid rgba(255,255,255,0.05);
}

.level-description-content h2 {
  color: var(--blue);
  margin-bottom: 20px;
  text-align: center;
}

.level-objective {
  background: rgba(46,242,123,0.05);
  border-left: 3px solid var(--green);
  padding: 15px;
  border-radius: 8px;
  margin: 15px 0;
}

.level-tips {
  background: rgba(255,209,102,0.05);
  border-left: 3px solid var(--yellow);
  padding: 15px;
  border-radius: 8px;
  margin: 15px 0;
}

.level-rewards {
  background: rgba(192,132,252,0.05);
  border-left: 3px solid var(--purple);
  padding: 15px;
  border-radius: 8px;
  margin: 15px 0;
}

@media (max-width:1000px){
  .container{flex-direction:column; padding:12px;} 
  .left,.right{width:100%;} 
  .editor-wrap{height:36vh;} 
  #console{height:26vh;} 
  .game-over-text{font-size:48px;}
  .map-selection { grid-template-columns: 1fr; }
}
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/codemirror.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/theme/dracula.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/codemirror.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/python/python.min.js"></script>
<script src="https://cdn.jsdelivr.net/pyodide/v0.23.4/full/pyodide.js"></script>
</head>
<body>

<!-- –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é -->
<div id="mainMenu">
  <div class="menu-container">
    
    <!-- –≠–∫—Ä–∞–Ω –≤—Ö–æ–¥–∞ -->
    <div id="loginSection" class="menu-section active">
      <h1 class="menu-title">üöÄ Tower Defense Python</h1>
      <p class="menu-subtitle">–£–ø—Ä–∞–≤–ª—è–π—Ç–µ –∑–∞—â–∏—Ç–æ–π —Å –ø–æ–º–æ—â—å—é Python –∫–æ–¥–∞</p>
      
      <div class="input-group">
        <input type="text" id="loginUsername" placeholder="–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è">
      </div>
      <div class="input-group">
        <input type="password" id="loginPassword" placeholder="–ü–∞—Ä–æ–ª—å">
      </div>
      
      <button class="btn-menu" onclick="login()">–í–æ–π—Ç–∏</button>
      <button class="btn-menu btn-secondary" onclick="showRegister()">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
      <button class="btn-menu btn-secondary" onclick="playAsGuest()">–ò–≥—Ä–∞—Ç—å –∫–∞–∫ –≥–æ—Å—Ç—å</button>
    </div>
    
    <!-- –≠–∫—Ä–∞–Ω —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ -->
    <div id="registerSection" class="menu-section">
      <h1 class="menu-title">üìù –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h1>
      
      <div class="input-group">
        <input type="text" id="registerUsername" placeholder="–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–º–∏–Ω. 3 —Å–∏–º–≤–æ–ª–∞)">
      </div>
      <div class="input-group">
        <input type="password" id="registerPassword" placeholder="–ü–∞—Ä–æ–ª—å (–º–∏–Ω. 4 —Å–∏–º–≤–æ–ª–∞)">
      </div>
      <div class="input-group">
        <input type="password" id="registerConfirm" placeholder="–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å">
      </div>
      
      <button class="btn-menu" onclick="register()">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
      <button class="btn-menu btn-secondary" onclick="showLogin()">–ù–∞–∑–∞–¥ –∫ –≤—Ö–æ–¥—É</button>
    </div>
    
    <!-- –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é –ø–æ—Å–ª–µ –≤—Ö–æ–¥–∞ -->
    <div id="mainMenuSection" class="menu-section">
      <div class="user-info">
        <h3>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, <span id="currentUserName">–ì–æ—Å—Ç—å</span>!</h3>
        <div class="user-stats">
          <div class="stat-item">
            <span class="stat-value" id="userBestWave">0</span>
            <span>–õ—É—á—à–∞—è –≤–æ–ª–Ω–∞</span>
          </div>
          <div class="stat-item">
            <span class="stat-value" id="userTotalKills">0</span>
            <span>–í—Å–µ–≥–æ —É–±–∏—Ç–æ</span>
          </div>
        </div>
      </div>
      
      <button class="btn-menu" onclick="showCampaignLevels()">üéÆ –ö–∞–º–ø–∞–Ω–∏—è</button>
      <button class="btn-menu" onclick="showSandboxMaps()">‚àû –ë–µ—Å–∫–æ–Ω–µ—á–Ω—ã–π —Ä–µ–∂–∏–º</button>
      <button class="btn-menu btn-secondary" onclick="showLeaderboards()">üèÜ –¢–∞–±–ª–∏—Ü–∞ –ª–∏–¥–µ—Ä–æ–≤</button>
      <button class="btn-menu btn-secondary" onclick="logout()">üö™ –í—ã–π—Ç–∏</button>
    </div>
    
    <!-- –í—ã–±–æ—Ä –∫–∞—Ä—Ç—ã –¥–ª—è –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞ -->
    <div id="sandboxMapSection" class="menu-section">
      <h1 class="menu-title">‚àû –í—ã–±–æ—Ä –∫–∞—Ä—Ç—ã</h1>
      <p class="menu-subtitle">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ä—Ç—É –¥–ª—è –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ–π –∏–≥—Ä—ã</p>
      
      <div class="map-selection">
        <div class="map-card" onclick="selectMap('wave')">
          <h4>üåä –í–æ–ª–Ω–æ–≤–∞—è</h4>
          <span class="map-difficulty">–õ–µ–≥–∫–∞—è</span>
          <p class="map-record" id="recordWave">–í–∞—à —Ä–µ–∫–æ—Ä–¥: 0 –≤–æ–ª–Ω</p>
        </div>
        
        <div class="map-card" onclick="selectMap('zigzag')">
          <h4>‚ö° –ó–∏–≥–∑–∞–≥</h4>
          <span class="map-difficulty">–°—Ä–µ–¥–Ω—è—è</span>
          <p class="map-record" id="recordZigzag">–í–∞—à —Ä–µ–∫–æ—Ä–¥: 0 –≤–æ–ª–Ω</p>
        </div>
        
        <div class="map-card" onclick="selectMap('curve')">
          <h4>üåÄ –ò–∑–≤–∏–ª–∏—Å—Ç–∞—è</h4>
          <span class="map-difficulty">–°–ª–æ–∂–Ω–∞—è</span>
          <p class="map-record" id="recordCurve">–í–∞—à —Ä–µ–∫–æ—Ä–¥: 0 –≤–æ–ª–Ω</p>
        </div>
        
        <div class="map-card" onclick="selectMap('straight')">
          <h4>‚û°Ô∏è –ü—Ä—è–º–∞—è</h4>
          <span class="map-difficulty">–≠–∫—Å—Ç—Ä–µ–º–∞–ª—å–Ω–∞—è</span>
          <p class="map-record" id="recordStraight">–í–∞—à —Ä–µ–∫–æ—Ä–¥: 0 –≤–æ–ª–Ω</p>
        </div>
      </div>
      
      <button class="btn-menu" onclick="startSandbox()">–ù–∞—á–∞—Ç—å –∏–≥—Ä—É</button>
      <button class="btn-menu btn-secondary" onclick="showMainMenu()">‚Üê –ù–∞–∑–∞–¥</button>
    </div>
    
    <!-- –í—ã–±–æ—Ä —É—Ä–æ–≤–Ω—è –∫–∞–º–ø–∞–Ω–∏–∏ -->
    <div id="campaignLevelsSection" class="menu-section">
      <h1 class="menu-title">üéÆ –ö–∞–º–ø–∞–Ω–∏—è</h1>
      <p class="menu-subtitle">–ü—Ä–æ–≥—Ä–µ—Å—Å: <span id="campaignProgressText">–£—Ä–æ–≤–µ–Ω—å 1/5</span></p>
      
      <div class="level-description" id="selectedLevelDescription" style="display: none;">
        <!-- –û–ø–∏—Å–∞–Ω–∏–µ —É—Ä–æ–≤–Ω—è –±—É–¥–µ—Ç –∑–∞–ø–æ–ª–Ω—è—Ç—å—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
      </div>
      
      <div class="map-selection">
        <div class="map-card campaign-level" data-level="1" onclick="selectCampaignLevel(1)">
          <h4>–£—Ä–æ–≤–µ–Ω—å 1: –û—Å–Ω–æ–≤—ã</h4>
          <span class="map-difficulty">–û–±—É—á–µ–Ω–∏–µ</span>
          <p>–ü–æ—Å—Ç—Ä–æ–π—Ç–µ 3 –±–∞—à–Ω–∏ –¥–ª—è –∑–∞—â–∏—Ç—ã</p>
        </div>
        
        <div class="map-card campaign-level" data-level="2" onclick="selectCampaignLevel(2)">
          <h4>–£—Ä–æ–≤–µ–Ω—å 2: –£–ª—É—á—à–µ–Ω–∏—è</h4>
          <span class="map-difficulty">–õ–µ–≥–∫–∏–π</span>
          <p>–£–ª—É—á—à–∏—Ç–µ –±–∞—à–Ω–∏ –¥–æ 3 —É—Ä–æ–≤–Ω—è</p>
        </div>
        
        <div class="map-card campaign-level" data-level="3" onclick="selectCampaignLevel(3)">
          <h4>–£—Ä–æ–≤–µ–Ω—å 3: –õ–∞–±–∏—Ä–∏–Ω—Ç</h4>
          <span class="map-difficulty">–°—Ä–µ–¥–Ω–∏–π</span>
          <p>–ó–∞—â–∏—Ç–∏—Ç–µ –∏–∑–≤–∏–ª–∏—Å—Ç—ã–π –ø—É—Ç—å</p>
        </div>
        
        <div class="map-card campaign-level" data-level="4" onclick="selectCampaignLevel(4)">
          <h4>–£—Ä–æ–≤–µ–Ω—å 4: –ó–∏–≥–∑–∞–≥</h4>
          <span class="map-difficulty">–°–ª–æ–∂–Ω—ã–π</span>
          <p>–ë–∞–ª–∞–Ω—Å –º–µ–∂–¥—É –¥–∞–ª—å–Ω–æ—Å—Ç—å—é –∏ —É—Ä–æ–Ω–æ–º</p>
        </div>
        
        <div class="map-card campaign-level" data-level="5" onclick="selectCampaignLevel(5)">
          <h4>–£—Ä–æ–≤–µ–Ω—å 5: –§–∏–Ω–∞–ª—å–Ω—ã–π</h4>
          <span class="map-difficulty">–≠–∫—Å—Ç—Ä–µ–º–∞–ª—å–Ω—ã–π</span>
          <p>–ü—Ä—è–º–∞—è –∞—Ç–∞–∫–∞ - –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏</p>
        </div>
      </div>
      
      <button class="btn-menu" id="startCampaignBtn" onclick="startCampaign()" disabled>–ù–∞—á–∞—Ç—å —É—Ä–æ–≤–µ–Ω—å</button>
      <button class="btn-menu btn-secondary" onclick="showMainMenu()">‚Üê –ù–∞–∑–∞–¥</button>
    </div>
    
    <!-- –¢–∞–±–ª–∏—Ü–∞ –ª–∏–¥–µ—Ä–æ–≤ -->
    <div id="leaderboardSection" class="menu-section">
      <h1 class="menu-title">üèÜ –¢–∞–±–ª–∏—Ü–∞ –ª–∏–¥–µ—Ä–æ–≤</h1>
      
      <div style="margin-bottom: 15px;">
        <select id="leaderboardMapSelect" onchange="loadLeaderboard()">
          <option value="wave">üåä –í–æ–ª–Ω–æ–≤–∞—è</option>
          <option value="zigzag">‚ö° –ó–∏–≥–∑–∞–≥</option>
          <option value="curve">üåÄ –ò–∑–≤–∏–ª–∏—Å—Ç–∞—è</option>
          <option value="straight">‚û°Ô∏è –ü—Ä—è–º–∞—è</option>
        </select>
      </div>
      
      <div class="leaderboard-container">
        <table class="leaderboard-table">
          <thead>
            <tr>
              <th>#</th>
              <th>–ò–≥—Ä–æ–∫</th>
              <th>–í–æ–ª–Ω–∞</th>
              <th>–û—á–∫–∏</th>
            </tr>
          </thead>
          <tbody id="leaderboardTable">
            <!-- –ó–∞–ø–æ–ª–Ω–∏—Ç—Å—è JavaScript -->
          </tbody>
        </table>
      </div>
      
      <button class="btn-menu btn-secondary" onclick="showMainMenu()" style="margin-top: 20px;">‚Üê –ù–∞–∑–∞–¥</button>
    </div>
    
  </div>
</div>

<!-- –û—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–∞—è –∏–≥—Ä–∞ (–∏–∑–Ω–∞—á–∞–ª—å–Ω–æ —Å–∫—Ä—ã—Ç–∞) -->
<div class="container" style="display: none;">
  <div class="left card">
    <div class="panel-title">
      <h1 id="gameTitle">Tower Defense</h1>
      <div style="display:flex;gap:10px;align-items:center">
        <div class="chip" id="wave">–í–æ–ª–Ω–∞: 0</div>
        <div class="chip" id="money">–î–µ–Ω—å–≥–∏: 100</div>
        <div class="chip" id="lives">–ñ–∏–∑–Ω–∏: 10</div>
        <div class="chip" id="score">–°—á—ë—Ç: 0</div>
      </div>
    </div>
    <div id="gameWrap">
      <canvas id="gameCanvas"></canvas>
      
      <!-- –≠–∫—Ä–∞–Ω –æ–ø–∏—Å–∞–Ω–∏—è —É—Ä–æ–≤–Ω—è -->
      <div id="levelDescription">
        <div class="level-description-content">
          <h2 id="levelDescriptionTitle">–£—Ä–æ–≤–µ–Ω—å 1: –û—Å–Ω–æ–≤—ã</h2>
          <div class="level-objective">
            <h3>üéØ –¶–µ–ª—å —É—Ä–æ–≤–Ω—è:</h3>
            <p id="levelObjectiveText">–ü—Ä–æ–π–¥–∏—Ç–µ 5 –≤–æ–ª–Ω, –ø–æ—Å—Ç—Ä–æ–∏–≤ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—É—é –∑–∞—â–∏—Ç—É</p>
          </div>
          <div class="level-tips">
            <h3>üí° –°–æ–≤–µ—Ç—ã:</h3>
            <ul id="levelTipsList">
              <li>–ù–∞—á–Ω–∏—Ç–µ —Å –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –±–∞—à–µ–Ω –Ω–∞ –∫–ª—é—á–µ–≤—ã—Ö —Ç–æ—á–∫–∞—Ö –ø—É—Ç–∏</li>
              <li>–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ñ—É–Ω–∫—Ü–∏—é build_tower("–∏–º—è", x, y)</li>
              <li>–£–ª—É—á—à–∞–π—Ç–µ –±–∞—à–Ω–∏ –¥–ª—è —É–≤–µ–ª–∏—á–µ–Ω–∏—è —É—Ä–æ–Ω–∞</li>
            </ul>
          </div>
          <div class="level-rewards">
            <h3>üèÜ –ù–∞–≥—Ä–∞–¥–∞:</h3>
            <p id="levelRewardText">–û—Ç–∫—Ä–æ–µ—Ç—Å—è —Å–ª–µ–¥—É—é—â–∏–π —É—Ä–æ–≤–µ–Ω—å –∫–∞–º–ø–∞–Ω–∏–∏</p>
          </div>
          <button class="btn-menu" onclick="hideLevelDescription()" style="margin-top: 20px;">–ù–∞—á–∞—Ç—å –∏–≥—Ä—É</button>
        </div>
      </div>
      
      <div id="ruler">
        <div>–®–∏—Ä–∏–Ω–∞: <span id="canvasWidth">0</span></div>
        <div>–í—ã—Å–æ—Ç–∞: <span id="canvasHeight">0</span></div>
        <div class="coordinates">–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã: (<span id="mouseX">0</span>, <span id="mouseY">0</span>)</div>
      </div>
      <button class="btn small ruler-toggle" id="toggleRulerBtn">üìè</button>
      <div id="gameOver">
        <div class="game-over-text">GAME OVER</div>
        <div class="game-over-subtext">–í–æ–ª–Ω–∞: <span id="finalWave">0</span> | –°—á—ë—Ç: <span id="finalScore">0</span></div>
        <div class="game-over-stats">
          <div>–£–±–∏—Ç–æ –≤—Ä–∞–≥–æ–≤: <span id="kills">0</span></div>
          <div>–ü–æ—Å—Ç—Ä–æ–µ–Ω–æ –±–∞—à–µ–Ω: <span id="towersBuilt">0</span></div>
          <div>–í—Å–µ–≥–æ —É–ª—É—á—à–µ–Ω–∏–π: <span id="upgradesDone">0</span></div>
        </div>
        <div class="game-over-subtext pulse">–ù–∞–∂–º–∏—Ç–µ –ª—é–±—É—é –∫–Ω–æ–ø–∫—É –¥–ª—è –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è</div>
      </div>
    </div>
    <div class="controls-row">
      <div class="chip" id="mapInfo">–ö–∞—Ä—Ç–∞: –í–æ–ª–Ω–æ–≤–∞—è</div>
      <div style="flex:1"></div>
      <button class="btn small" id="menuBtn" onclick="returnToMenu()">üè† –ú–µ–Ω—é</button>
      <button class="btn small danger" id="resetBtn">Reset</button>
    </div>
  </div>
  <div class="right">
    <div class="card editor-wrap">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div class="tabs">
          <div class="tab active" data-tab="editor">Editor</div>
          <div class="tab" data-tab="guide">Guide</div>
        </div>
        <div style="display:flex;gap:8px">
          <button class="btn small" id="runBtn">Run (Ctrl+Enter)</button>
        </div>
      </div>
      <div id="editor"></div>
      <div id="guidePanel" class="guide-content">
        <h3 style="color:var(--blue); margin-bottom:12px;">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏–≥—Ä–æ–π —á–µ—Ä–µ–∑ Python</h3>
        
        <h4>–û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:</h4>
        <ul>
          <li><code>build_tower(–∏–º—è, x, y)</code> - –ø–æ—Å—Ç—Ä–æ–∏—Ç—å –∏–º–µ–Ω–æ–≤–∞–Ω–Ω—É—é –±–∞—à–Ω—é</li>
          <li><code>upgrade_tower(–∏–º—è)</code> - —É–ª—É—á—à–∏—Ç—å –±–∞—à–Ω—é –ø–æ –∏–º–µ–Ω–∏</li>
          <li><code>spawn_wave()</code> - –∑–∞–ø—É—Å—Ç–∏—Ç—å –≤–æ–ª–Ω—É –≤—Ä–∞–≥–æ–≤</li>
          <li><code>reset_game()</code> - —Å–±—Ä–æ—Å–∏—Ç—å –∏–≥—Ä—É</li>
          <li><code>get_towers()</code> - –ø–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –±–∞—à–µ–Ω</li>
        </ul>

        <h3>–†–∞–±–æ—Ç–∞ —Å –∏–º–µ–Ω–∞–º–∏ –±–∞—à–µ–Ω</h3>
        
        <h4>–°–æ–∑–¥–∞–Ω–∏–µ –∏–º–µ–Ω–æ–≤–∞–Ω–Ω—ã—Ö –±–∞—à–µ–Ω:</h4>
        <pre># –°–æ–∑–¥–∞—Ç—å –±–∞—à–Ω–∏ —Å –∏–º–µ–Ω–∞–º–∏
build_tower("alpha", 100, 200)
build_tower("beta", 700, 200)  
build_tower("gamma", 400, 400)</pre>

        <h4>–£–ª—É—á—à–µ–Ω–∏–µ –ø–æ –∏–º–µ–Ω–∞–º:</h4>
        <pre># –£–ª—É—á—à–∞—Ç—å –±–∞—à–Ω–∏ –ø–æ –∏–º–µ–Ω–∞–º
upgrade_tower("alpha")
upgrade_tower("alpha")  # –í—Ç–æ—Ä–æ–µ —É–ª—É—á—à–µ–Ω–∏–µ
upgrade_tower("beta")</pre>

        <h4>–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —É–ª—É—á—à–µ–Ω–∏–µ:</h4>
        <pre># –£–ª—É—á—à–∏—Ç—å –≤—Å–µ –±–∞—à–Ω–∏ –¥–æ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–≥–æ —É—Ä–æ–≤–Ω—è
tower_names = ["alpha", "beta", "gamma", "delta"]

for name in tower_names:
    for i in range(5):  # –ú–∞–∫—Å–∏–º—É–º 5 —É–ª—É—á—à–µ–Ω–∏–π
        if not upgrade_tower(name):
            break  # –ï—Å–ª–∏ —É–ª—É—á—à–µ–Ω–∏–µ –Ω–µ —É–¥–∞–ª–æ—Å—å, –ø–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Å–ª–µ–¥—É—é—â–µ–π –±–∞—à–Ω–µ</pre>

        <h3>–°—Ç—Ä–∞—Ç–µ–≥–∏–∏ —Ä–∞–∑–º–µ—â–µ–Ω–∏—è</h3>
        
        <h4>–ó–∞—â–∏—Ç–Ω–∞—è —Ñ–æ—Ä–º–∞—Ü–∏—è:</h4>
        <pre># –°–æ–∑–¥–∞—Ç—å –∑–∞—â–∏—Ç–Ω—É—é —Ñ–æ—Ä–º–∞—Ü–∏—é —Å –∏–º–µ–Ω–∞–º–∏
def create_defense():
    # –û—Å–Ω–æ–≤–Ω—ã–µ –∑–∞—â–∏—Ç–Ω—ã–µ —Ç–æ—á–∫–∏
    build_tower("frontline_1", 200, 250)
    build_tower("frontline_2", 600, 250)
    
    # –¢—ã–ª–æ–≤—ã–µ –±–∞—à–Ω–∏
    build_tower("backup_1", 300, 350)
    build_tower("backup_2", 500, 350)
    
    # –£–ª—É—á—à–∏—Ç—å –æ—Å–Ω–æ–≤–Ω—ã–µ —Ç–æ—á–∫–∏
    upgrade_tower("frontline_1")
    upgrade_tower("frontline_2")

create_defense()</pre>

        <h4>–ö—Ä—É–≥–æ–≤–∞—è –∑–∞—â–∏—Ç–∞:</h4>
        <pre># –†–∞–∑–º–µ—Å—Ç–∏—Ç—å –±–∞—à–Ω–∏ –ø–æ –∫—Ä—É–≥—É
import math

def build_circle_towers(center_x, center_y, radius, count):
    names = ["north", "east", "south", "west", "ne", "se", "sw", "nw"]
    for i in range(count):
        angle = 2 * math.pi * i / count
        x = center_x + radius * math.cos(angle)
        y = center_y + radius * math.sin(angle)
        name = names[i] if i < len(names) else f"tower_{i}"
        build_tower(name, x, y)

build_circle_towers(400, 300, 150, 8)</pre>

        <h3>–ü–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –±–∞—à–Ω—è—Ö</h3>
        
        <pre># –ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –±–∞—à–µ–Ω –∏ –∏—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
towers = get_towers()
for tower in towers:
    print(f"–ë–∞—à–Ω—è '{tower['name']}': —É—Ä–æ–≤–µ–Ω—å {tower['level']}, –ø–æ–∑–∏—Ü–∏—è ({tower['x']}, {tower['y']})")</pre>

        <h3>–ü—Ä–∏–º–µ—Ä—ã —Å —Ü–∏–∫–ª–∞–º–∏</h3>
        
        <h4>–ú–∞—Å—Å–æ–≤–æ–µ —É–ª—É—á—à–µ–Ω–∏–µ –ø–æ –∏–º–µ–Ω–∞–º:</h4>
        <pre># –£–ª—É—á—à–∏—Ç—å –≤—Å–µ –∏–º–µ–Ω–æ–≤–∞–Ω–Ω—ã–µ –±–∞—à–Ω–∏
def upgrade_all_towers():
    towers = get_towers()
    for tower in towers:
        upgrade_tower(tower['name'])

upgrade_all_towers()</pre>

        <h4>–°—Ç—Ä–∞—Ç–µ–≥–∏—è –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω–æ–≥–æ —É–ª—É—á—à–µ–Ω–∏—è:</h4>
        <pre># –£–ª—É—á—à–∞—Ç—å —Ç–æ–ª—å–∫–æ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã–µ –±–∞—à–Ω–∏
priority_towers = ["frontline_1", "frontline_2", "alpha", "beta"]

for tower_name in priority_towers:
    for i in range(3):  # 3 —É–ª—É—á—à–µ–Ω–∏—è –¥–ª—è –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—ã—Ö –±–∞—à–µ–Ω
        upgrade_tower(tower_name)</pre>

        <h3>–†–∞–±–æ—Ç–∞ —Å –∏—Å–∫–ª—é—á–µ–Ω–∏—è–º–∏</h3>
        
        <pre># –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ —Å—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤–æ —Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –æ—à–∏–±–æ–∫
def safe_build_tower(name, x, y):
    try:
        result = build_tower(name, x, y)
        if result:
            print(f"–ë–∞—à–Ω—è '{name}' –ø–æ—Å—Ç—Ä–æ–µ–Ω–∞ –≤ ({x}, {y})")
        else:
            print(f"–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ—Å—Ç—Ä–æ–∏—Ç—å –±–∞—à–Ω—é '{name}'")
    except Exception as e:
        print(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤–µ: {e}")

safe_build_tower("test_tower", 300, 200)</pre>

        <h4>–°—Ç–æ–∏–º–æ—Å—Ç—å:</h4>
        <ul>
          <li>–ü–æ—Å—Ç—Ä–æ–π–∫–∞ –±–∞—à–Ω–∏: <strong>50</strong> –¥–µ–Ω–µ–≥</li>
          <li>–£–ª—É—á—à–µ–Ω–∏–µ –±–∞—à–Ω–∏: <strong>30</strong> –¥–µ–Ω–µ–≥</li>
          <li>–£–±–∏–π—Å—Ç–≤–æ –≤—Ä–∞–≥–∞: <strong>+10</strong> –¥–µ–Ω–µ–≥</li>
        </ul>

        <h4>–°–æ–≤–µ—Ç—ã:</h4>
        <ul>
          <li>–î–∞–≤–∞–π—Ç–µ –±–∞—à–Ω—è–º –æ—Å–º—ã—Å–ª–µ–Ω–Ω—ã–µ –∏–º–µ–Ω–∞ –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è</li>
          <li>–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∏–º–µ–Ω–∞ –¥–ª—è –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω–æ–≥–æ —É–ª—É—á—à–µ–Ω–∏—è –∫–ª—é—á–µ–≤—ã—Ö –±–∞—à–µ–Ω</li>
          <li>–°–ª–µ–¥–∏—Ç–µ –∑–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º –¥–µ–Ω–µ–≥ –∏ –∂–∏–∑–Ω–µ–π</li>
          <li>–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ª–∏–Ω–µ–π–∫—É –¥–ª—è —Ç–æ—á–Ω–æ–≥–æ –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è</li>
        </ul>
      </div>
    </div>
    <div class="card">
      <div id="console" aria-live="polite"></div>
      <div class="footer-row">
        <div class="hint">–§—É–Ω–∫—Ü–∏–∏: <code>build_tower("–∏–º—è", x, y)</code>, <code>upgrade_tower("–∏–º—è")</code></div>
        <div style="display:flex;gap:8px">
          <button class="btn small" id="clearConsoleBtn">Clear</button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// ============================================
// –ë–ê–ó–ê –î–ê–ù–ù–´–• –ò –°–ò–°–¢–ï–ú–ê –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–ï–ô
// ============================================
const TD_DB = {
    key: 'tower_defense_db_final',
    
    init() {
        if (!localStorage.getItem(this.key)) {
            const initialData = {
                users: [],
                leaderboards: {
                    map_wave: [],
                    map_zigzag: [],
                    map_curve: [],
                    map_straight: []
                }
            };
            localStorage.setItem(this.key, JSON.stringify(initialData));
            console.log('[–°–∏—Å—Ç–µ–º–∞] –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö —Å–æ–∑–¥–∞–Ω–∞');
        }
        return this.getDB();
    },
    
    getDB() {
        return JSON.parse(localStorage.getItem(this.key));
    },
    
    saveDB(db) {
        localStorage.setItem(this.key, JSON.stringify(db));
    },
    
    register(username, password) {
        const db = this.getDB();
        
        if (username.length < 3) {
            return { success: false, message: '–ò–º—è –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –Ω–µ –º–µ–Ω–µ–µ 3 —Å–∏–º–≤–æ–ª–æ–≤' };
        }
        if (password.length < 4) {
            return { success: false, message: '–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–µ –º–µ–Ω–µ–µ 4 —Å–∏–º–≤–æ–ª–æ–≤' };
        }
        
        if (db.users.some(u => u.username.toLowerCase() === username.toLowerCase())) {
            return { success: false, message: '–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —É–∂–µ –∑–∞–Ω—è—Ç–æ' };
        }
        
        const newUser = {
            id: Date.now().toString(),
            username: username,
            password: btoa(username + ':' + password),
            registered: new Date().toISOString(),
            campaignProgress: 1,
            mapRecords: {
                wave: 0,
                zigzag: 0,
                curve: 0,
                straight: 0
            },
            stats: {
                totalKills: 0,
                totalWaves: 0,
                totalPlayTime: 0,
                gamesPlayed: 0
            }
        };
        
        db.users.push(newUser);
        this.saveDB(db);
        
        return { 
            success: true, 
            message: '–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞!',
            user: { 
                username: newUser.username, 
                id: newUser.id,
                mapRecords: newUser.mapRecords 
            }
        };
    },
    
    login(username, password) {
        const db = this.getDB();
        const user = db.users.find(u => 
            u.username.toLowerCase() === username.toLowerCase() && 
            u.password === btoa(username + ':' + password)
        );
        
        if (user) {
            return { 
                success: true, 
                user: {
                    id: user.id,
                    username: user.username,
                    campaignProgress: user.campaignProgress,
                    mapRecords: user.mapRecords,
                    stats: user.stats
                }
            };
        }
        
        return { success: false, message: '–ù–µ–≤–µ—Ä–Ω—ã–π –ª–æ–≥–∏–Ω –∏–ª–∏ –ø–∞—Ä–æ–ª—å' };
    },
    
    updateCampaignProgress(username, level) {
        const db = this.getDB();
        const user = db.users.find(u => u.username === username);
        if (!user) return false;
        
        if (level > user.campaignProgress) {
            user.campaignProgress = level;
            this.saveDB(db);
            return true;
        }
        return false;
    },
    
    updateRecord(username, mapId, waveReached, score, kills) {
        const db = this.getDB();
        const user = db.users.find(u => u.username === username);
        if (!user) return false;
        
        let isNewRecord = false;
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –ª–∏—á–Ω—ã–π —Ä–µ–∫–æ—Ä–¥
        if (waveReached > user.mapRecords[mapId]) {
            user.mapRecords[mapId] = waveReached;
            isNewRecord = true;
        }
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
        user.stats.totalKills += kills;
        user.stats.totalWaves += waveReached;
        user.stats.gamesPlayed++;
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–π –ª–∏–¥–µ—Ä–±–æ—Ä–¥
        const leaderboardKey = `map_${mapId}`;
        const leaderboard = db.leaderboards[leaderboardKey];
        const existingEntryIndex = leaderboard.findIndex(entry => entry.username === username);
        
        const newEntry = {
            username: username,
            wave: waveReached,
            score: score,
            kills: kills,
            date: new Date().toISOString()
        };
        
        if (existingEntryIndex !== -1) {
            if (waveReached > leaderboard[existingEntryIndex].wave) {
                leaderboard[existingEntryIndex] = newEntry;
            }
        } else {
            leaderboard.push(newEntry);
        }
        
        // –°–æ—Ä—Ç–∏—Ä—É–µ–º –∏ –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º —Ç–æ–ø-20
        leaderboard.sort((a, b) => {
            if (b.wave !== a.wave) return b.wave - a.wave;
            return b.score - a.score;
        });
        
        if (leaderboard.length > 20) {
            db.leaderboards[leaderboardKey] = leaderboard.slice(0, 20);
        }
        
        this.saveDB(db);
        return isNewRecord;
    },
    
    getLeaderboard(mapId) {
        const db = this.getDB();
        return db.leaderboards[`map_${mapId}`] || [];
    },
    
    getUserRecords(username) {
        const db = this.getDB();
        const user = db.users.find(u => u.username === username);
        return user ? user.mapRecords : null;
    }
};

// ============================================
// –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï –ò –ù–ê–°–¢–†–û–ô–ö–ò
// ============================================
let currentUser = null;
let currentMap = 'wave';
let gameMode = 'sandbox'; // 'campaign' –∏–ª–∏ 'sandbox'
let currentCampaignLevel = 1;
let selectedCampaignLevel = 1;
let gameStartTime = 0;
let canChangeMap = true; // –§–ª–∞–≥ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∫–∞—Ä—Ç—ã

// –û–ø–∏—Å–∞–Ω–∏—è —É—Ä–æ–≤–Ω–µ–π –∫–∞–º–ø–∞–Ω–∏–∏
const campaignLevels = {
    1: {
        title: "–£—Ä–æ–≤–µ–Ω—å 1: –û—Å–Ω–æ–≤—ã",
        map: "wave",
        objective: "–ü—Ä–æ–π–¥–∏—Ç–µ 5 –≤–æ–ª–Ω –≤—Ä–∞–≥–æ–≤",
        description: "–í —ç—Ç–æ–º —É—Ä–æ–≤–Ω–µ –≤—ã –Ω–∞—É—á–∏—Ç–µ—Å—å –æ—Å–Ω–æ–≤–∞–º –∏–≥—Ä—ã: —Å—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤—É –±–∞—à–µ–Ω –∏ –∏—Ö —Ä–∞–∑–º–µ—â–µ–Ω–∏—é.",
        tips: [
            "–ù–∞—á–Ω–∏—Ç–µ —Å –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –±–∞—à–µ–Ω –Ω–∞ –∫–ª—é—á–µ–≤—ã—Ö —Ç–æ—á–∫–∞—Ö –≤–æ–ª–Ω–æ–≤–æ–≥–æ –ø—É—Ç–∏",
            "–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ñ—É–Ω–∫—Ü–∏—é build_tower('–∏–º—è', x, y) –¥–ª—è —Å—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤–∞",
            "–†–∞–∑–º–µ—â–∞–π—Ç–µ –±–∞—à–Ω–∏ –Ω–∞ –∏–∑–≥–∏–±–∞—Ö –ø—É—Ç–∏ –¥–ª—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏"
        ],
        rewards: "–û—Ç–∫—Ä–æ–µ—Ç—Å—è –£—Ä–æ–≤–µ–Ω—å 2: –£–ª—É—á—à–µ–Ω–∏—è",
        wavesToWin: 5,
        startingMoney: 150,
        startingLives: 10
    },
    2: {
        title: "–£—Ä–æ–≤–µ–Ω—å 2: –£–ª—É—á—à–µ–Ω–∏—è",
        map: "curve",
        objective: "–ü—Ä–æ–π–¥–∏—Ç–µ 8 –≤–æ–ª–Ω, —É–ª—É—á—à–∞—è –±–∞—à–Ω–∏",
        description: "–¢–µ–ø–µ—Ä—å –≤–∞–º –Ω—É–∂–Ω–æ –Ω–µ —Ç–æ–ª—å–∫–æ —Å—Ç—Ä–æ–∏—Ç—å, –Ω–æ –∏ —É–ª—É—á—à–∞—Ç—å –±–∞—à–Ω–∏ –¥–ª—è —É–≤–µ–ª–∏—á–µ–Ω–∏—è –∏—Ö —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏.",
        tips: [
            "–ü–æ—Å—Ç—Ä–æ–π—Ç–µ –º–∏–Ω–∏–º—É–º 3 –±–∞—à–Ω–∏ –≤ —Å—Ç—Ä–∞—Ç–µ–≥–∏—á–µ—Å–∫–∏—Ö —Ç–æ—á–∫–∞—Ö",
            "–£–ª—É—á—à–∞–π—Ç–µ –±–∞—à–Ω–∏ —Å –ø–æ–º–æ—â—å—é upgrade_tower('–∏–º—è')",
            "–ë–∞–ª–∞–Ω—Å–∏—Ä—É–π—Ç–µ –º–µ–∂–¥—É —Å—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤–æ–º –Ω–æ–≤—ã—Ö –±–∞—à–µ–Ω –∏ —É–ª—É—á—à–µ–Ω–∏–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö"
        ],
        rewards: "–û—Ç–∫—Ä–æ–µ—Ç—Å—è –£—Ä–æ–≤–µ–Ω—å 3: –õ–∞–±–∏—Ä–∏–Ω—Ç",
        wavesToWin: 8,
        startingMoney: 200,
        startingLives: 10
    },
    3: {
        title: "–£—Ä–æ–≤–µ–Ω—å 3: –õ–∞–±–∏—Ä–∏–Ω—Ç",
        map: "zigzag",
        objective: "–ü—Ä–æ–π–¥–∏—Ç–µ 10 –≤–æ–ª–Ω –Ω–∞ —Å–ª–æ–∂–Ω–æ–º –∑–∏–≥–∑–∞–≥–æ–æ–±—Ä–∞–∑–Ω–æ–º –ø—É—Ç–∏",
        description: "–°–ª–æ–∂–Ω—ã–π –ø—É—Ç—å —Ç—Ä–µ–±—É–µ—Ç —Ç—â–∞—Ç–µ–ª—å–Ω–æ–≥–æ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è —Ä–∞–∑–º–µ—â–µ–Ω–∏—è –±–∞—à–µ–Ω.",
        tips: [
            "–†–∞–∑–º–µ—â–∞–π—Ç–µ –±–∞—à–Ω–∏ –≤ —Ç–æ—á–∫–∞—Ö, –≥–¥–µ –ø—É—Ç—å –º–µ–Ω—è–µ—Ç –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ",
            "–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –±–∞—à–Ω–∏ —Å –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π –¥–∞–ª—å–Ω–æ—Å—Ç—å—é",
            "–£–ª—É—á—à–∞–π—Ç–µ –¥–∞–ª—å–Ω–æ—Å—Ç—å –∞—Ç–∞–∫–∏ –¥–ª—è –æ—Ö–≤–∞—Ç–∞ –±–æ–ª—å—à–µ–π —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏–∏"
        ],
        rewards: "–û—Ç–∫—Ä–æ–µ—Ç—Å—è –£—Ä–æ–≤–µ–Ω—å 4: –ó–∏–≥–∑–∞–≥",
        wavesToWin: 10,
        startingMoney: 250,
        startingLives: 10
    },
    4: {
        title: "–£—Ä–æ–≤–µ–Ω—å 4: –ó–∏–≥–∑–∞–≥",
        map: "zigzag",
        objective: "–ü—Ä–æ–π–¥–∏—Ç–µ 12 –≤–æ–ª–Ω —Å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω—ã–º–∏ —Ä–µ—Å—É—Ä—Å–∞–º–∏",
        description: "–≠—Ç–æ—Ç —É—Ä–æ–≤–µ–Ω—å –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –≤–∞—à–µ —É–º–µ–Ω–∏–µ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ä–µ—Å—É—Ä—Å—ã.",
        tips: [
            "–≠–∫–æ–Ω–æ–º–∏—Ç—å –¥–µ–Ω—å–≥–∏ - –∫–ª—é—á –∫ —É—Å–ø–µ—Ö—É",
            "–ù–µ —Å—Ç—Ä–æ–π—Ç–µ —Å–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –±–∞—à–µ–Ω –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ",
            "–°–Ω–∞—á–∞–ª–∞ —É–ª—É—á—à–∏—Ç–µ –∫–ª—é—á–µ–≤—ã–µ –±–∞—à–Ω–∏, –∑–∞—Ç–µ–º —Å—Ç—Ä–æ–π—Ç–µ –Ω–æ–≤—ã–µ"
        ],
        rewards: "–û—Ç–∫—Ä–æ–µ—Ç—Å—è –£—Ä–æ–≤–µ–Ω—å 5: –§–∏–Ω–∞–ª—å–Ω—ã–π",
        wavesToWin: 12,
        startingMoney: 200,
        startingLives: 8
    },
    5: {
        title: "–£—Ä–æ–≤–µ–Ω—å 5: –§–∏–Ω–∞–ª—å–Ω—ã–π",
        map: "straight",
        objective: "–ü—Ä–æ–π–¥–∏—Ç–µ 15 –≤–æ–ª–Ω –Ω–∞ –ø—Ä—è–º–æ–π –ª–∏–Ω–∏–∏",
        description: "–§–∏–Ω–∞–ª—å–Ω–æ–µ –∏—Å–ø—ã—Ç–∞–Ω–∏–µ! –ü—Ä—è–º–æ–π –ø—É—Ç—å –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ –≤—Ä–∞–≥–∏ –¥–≤–∏–∂—É—Ç—Å—è –±—ã—Å—Ç—Ä–æ –∏ –ø—Ä—è–º–æ –∫ —Ü–µ–ª–∏.",
        tips: [
            "–°—Ç—Ä–æ–π—Ç–µ –±–∞—à–Ω–∏ –±–ª–∏–∑–∫–æ –∫ –ø—É—Ç–∏ –¥–ª—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–≥–æ —É—Ä–æ–Ω–∞",
            "–°–æ–∑–¥–∞–π—Ç–µ –Ω–µ—Å–∫–æ–ª—å–∫–æ –ª–∏–Ω–∏–π –∑–∞—â–∏—Ç—ã",
            "–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –º–∞—Å—Å–æ–≤—ã–µ —É–ª—É—á—à–µ–Ω–∏—è –≤ –∫–æ–Ω—Ü–µ –ø—É—Ç–∏"
        ],
        rewards: "–ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –∫–∞–º–ø–∞–Ω–∏–∏ –∏ —Å–ø–µ—Ü–∏–∞–ª—å–Ω–∞—è –Ω–∞–≥—Ä–∞–¥–∞",
        wavesToWin: 15,
        startingMoney: 300,
        startingLives: 10
    }
};

// ============================================
// –§–£–ù–ö–¶–ò–ò –£–ü–†–ê–í–õ–ï–ù–ò–Ø –ú–ï–ù–Æ
// ============================================
function showSection(sectionId) {
    document.querySelectorAll('.menu-section').forEach(s => s.classList.remove('active'));
    const section = document.getElementById(sectionId);
    if (section) {
        section.classList.add('active');
    }
}

function showLogin() {
    showSection('loginSection');
    document.getElementById('loginUsername').value = '';
    document.getElementById('loginPassword').value = '';
}

function showRegister() {
    showSection('registerSection');
    document.getElementById('registerUsername').value = '';
    document.getElementById('registerPassword').value = '';
    document.getElementById('registerConfirm').value = '';
}

function showMainMenu() {
    showSection('mainMenuSection');
    if (currentUser) {
        document.getElementById('currentUserName').textContent = currentUser.username;
        document.getElementById('userBestWave').textContent = Math.max(
            currentUser.mapRecords?.wave || 0,
            currentUser.mapRecords?.zigzag || 0,
            currentUser.mapRecords?.curve || 0,
            currentUser.mapRecords?.straight || 0
        );
        document.getElementById('userTotalKills').textContent = currentUser.stats?.totalKills || 0;
    }
}

function showSandboxMaps() {
    showSection('sandboxMapSection');
    updateMapRecordsDisplay();
}

function showCampaignLevels() {
    showSection('campaignLevelsSection');
    updateCampaignLevelsDisplay();
}

function showLeaderboards() {
    showSection('leaderboardSection');
    loadLeaderboard();
}

function updateMapRecordsDisplay() {
    if (currentUser && currentUser.mapRecords) {
        document.getElementById('recordWave').textContent = `–í–∞—à —Ä–µ–∫–æ—Ä–¥: ${currentUser.mapRecords.wave} –≤–æ–ª–Ω`;
        document.getElementById('recordZigzag').textContent = `–í–∞—à —Ä–µ–∫–æ—Ä–¥: ${currentUser.mapRecords.zigzag} –≤–æ–ª–Ω`;
        document.getElementById('recordCurve').textContent = `–í–∞—à —Ä–µ–∫–æ—Ä–¥: ${currentUser.mapRecords.curve} –≤–æ–ª–Ω`;
        document.getElementById('recordStraight').textContent = `–í–∞—à —Ä–µ–∫–æ—Ä–¥: ${currentUser.mapRecords.straight} –≤–æ–ª–Ω`;
    }
}

function updateCampaignLevelsDisplay() {
    const campaignProgress = currentUser ? currentUser.campaignProgress : 1;
    document.getElementById('campaignProgressText').textContent = `–£—Ä–æ–≤–µ–Ω—å ${campaignProgress}/5`;
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å —É—Ä–æ–≤–Ω–µ–π
    document.querySelectorAll('.campaign-level').forEach(card => {
        const level = parseInt(card.dataset.level);
        if (level <= campaignProgress) {
            card.classList.remove('locked');
            card.style.cursor = 'pointer';
        } else {
            card.classList.add('locked');
            card.style.cursor = 'not-allowed';
        }
    });
    
    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π —É—Ä–æ–≤–µ–Ω—å
    selectedCampaignLevel = 1;
    document.querySelectorAll('.campaign-level').forEach(card => card.classList.remove('selected'));
    document.querySelector('.campaign-level[data-level="1"]').classList.add('selected');
    updateCampaignLevelDescription(1);
    document.getElementById('startCampaignBtn').disabled = false;
}

function selectMap(mapId) {
    currentMap = mapId;
    document.querySelectorAll('.map-card').forEach(card => card.classList.remove('selected'));
    event.target.closest('.map-card').classList.add('selected');
}

function selectCampaignLevel(level) {
    const campaignProgress = currentUser ? currentUser.campaignProgress : 1;
    if (level > campaignProgress) return;
    
    selectedCampaignLevel = level;
    document.querySelectorAll('.campaign-level').forEach(card => card.classList.remove('selected'));
    event.target.closest('.campaign-level').classList.add('selected');
    updateCampaignLevelDescription(level);
    document.getElementById('startCampaignBtn').disabled = false;
}

function updateCampaignLevelDescription(level) {
    const levelData = campaignLevels[level];
    if (!levelData) return;
    
    const descriptionDiv = document.getElementById('selectedLevelDescription');
    descriptionDiv.innerHTML = `
        <h3>${levelData.title}</h3>
        <p><strong>–¶–µ–ª—å:</strong> ${levelData.objective}</p>
        <p>${levelData.description}</p>
        <p><strong>–ù–∞–≥—Ä–∞–¥–∞:</strong> ${levelData.rewards}</p>
    `;
    descriptionDiv.style.display = 'block';
}

function loadLeaderboard() {
    const mapId = document.getElementById('leaderboardMapSelect').value;
    const leaderboard = TD_DB.getLeaderboard(mapId);
    const tbody = document.getElementById('leaderboardTable');
    tbody.innerHTML = '';
    
    if (leaderboard.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 20px;">–ü–æ–∫–∞ –Ω–µ—Ç –∑–∞–ø–∏—Å–µ–π –¥–ª—è —ç—Ç–æ–π –∫–∞—Ä—Ç—ã</td></tr>';
        return;
    }
    
    leaderboard.slice(0, 10).forEach((entry, index) => {
        const row = document.createElement('tr');
        let rankClass = '';
        if (index === 0) rankClass = 'rank-1';
        else if (index === 1) rankClass = 'rank-2';
        else if (index === 2) rankClass = 'rank-3';
        
        row.innerHTML = `
            <td class="${rankClass}">${index + 1}</td>
            <td class="${rankClass}">${entry.username}</td>
            <td>${entry.wave}</td>
            <td>${entry.score}</td>
        `;
        tbody.appendChild(row);
    });
}

function login() {
    const username = document.getElementById('loginUsername').value.trim();
    const password = document.getElementById('loginPassword').value;
    
    if (!username || !password) {
        alert('–í–≤–µ–¥–∏—Ç–µ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –ø–∞—Ä–æ–ª—å');
        return;
    }
    
    const result = TD_DB.login(username, password);
    if (result.success) {
        currentUser = result.user;
        sessionStorage.setItem('td_current_user', JSON.stringify(currentUser));
        showMainMenu();
    } else {
        alert(result.message);
    }
}

function register() {
    const username = document.getElementById('registerUsername').value.trim();
    const password = document.getElementById('registerPassword').value;
    const confirm = document.getElementById('registerConfirm').value;
    
    if (password !== confirm) {
        alert('–ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç');
        return;
    }
    
    const result = TD_DB.register(username, password);
    if (result.success) {
        currentUser = result.user;
        sessionStorage.setItem('td_current_user', JSON.stringify(currentUser));
        showMainMenu();
    } else {
        alert(result.message);
    }
}

function playAsGuest() {
    currentUser = {
        username: '–ì–æ—Å—Ç—å',
        mapRecords: { wave: 0, zigzag: 0, curve: 0, straight: 0 },
        stats: { totalKills: 0, totalWaves: 0 },
        campaignProgress: 1
    };
    startSandbox();
}

function logout() {
    currentUser = null;
    sessionStorage.removeItem('td_current_user');
    showLogin();
}

function returnToMenu() {
    document.querySelector('.container').style.display = 'none';
    document.getElementById('mainMenu').style.display = 'flex';
    showMainMenu();
}

function startCampaign() {
    if (selectedCampaignLevel < 1) return;
    
    gameMode = 'campaign';
    currentCampaignLevel = selectedCampaignLevel;
    const levelData = campaignLevels[currentCampaignLevel];
    currentMap = levelData.map;
    
    startGame();
}

function startSandbox() {
    gameMode = 'sandbox';
    startGame();
}

function getMapName(mapId) {
    const names = {
        wave: '–í–æ–ª–Ω–æ–≤–∞—è',
        zigzag: '–ó–∏–≥–∑–∞–≥',
        curve: '–ò–∑–≤–∏–ª–∏—Å—Ç–∞—è',
        straight: '–ü—Ä—è–º–∞—è'
    };
    return names[mapId] || mapId;
}

function showLevelDescription() {
    if (gameMode !== 'campaign') return;
    
    const levelData = campaignLevels[currentCampaignLevel];
    if (!levelData) return;
    
    document.getElementById('levelDescriptionTitle').textContent = levelData.title;
    document.getElementById('levelObjectiveText').textContent = levelData.objective;
    document.getElementById('levelRewardText').textContent = levelData.rewards;
    
    const tipsList = document.getElementById('levelTipsList');
    tipsList.innerHTML = '';
    levelData.tips.forEach(tip => {
        const li = document.createElement('li');
        li.textContent = tip;
        tipsList.appendChild(li);
    });
    
    document.getElementById('levelDescription').style.display = 'flex';
}

function hideLevelDescription() {
    document.getElementById('levelDescription').style.display = 'none';
}

// ============================================
// –û–†–ò–ì–ò–ù–ê–õ–¨–ù–´–ô –ö–û–î –ò–ì–†–´ (–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π)
// ============================================
let canvas = document.getElementById('gameCanvas');
let ctx = canvas.getContext('2d');
let dpr = Math.min(window.devicePixelRatio || 1, 2);
let enemies = [], towers = [], bullets = [], particles = [];
let lives = 10, wave = 0, money = 100, score = 0, kills = 0, towersBuilt = 0, upgradesDone = 0;
let waypoints = [];
let pathMode = 'wave';
let enemySpawnQueue = [];
let lastSpawnTime = 0;
let rulerVisible = true;
let mouseX = 0, mouseY = 0;
let requiredWaves = 0; // –î–ª—è –∫–∞–º–ø–∞–Ω–∏–∏
const $ = id => document.getElementById(id);

function log(msg){
  const t = new Date().toLocaleTimeString('ru');
  $('console').innerHTML = `<span style="color:#6ee7b7">[${t}]</span> ${msg}<br>` + $('console').innerHTML;
}

function updateUI(){
  $('lives').innerText = '–ñ–∏–∑–Ω–∏: '+lives;
  $('wave').innerText = '–í–æ–ª–Ω–∞: '+wave;
  $('money').innerText = '–î–µ–Ω—å–≥–∏: '+money;
  $('score').innerText = '–°—á—ë—Ç: '+score;
  
  // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–∞—Ä—Ç–µ
  if (gameMode === 'campaign') {
    $('mapInfo').innerText = `–£—Ä–æ–≤–µ–Ω—å ${currentCampaignLevel}`;
  } else {
    $('mapInfo').innerText = `–ö–∞—Ä—Ç–∞: ${getMapName(currentMap)}`;
  }
}

function resizeCanvas(){
  const rect = canvas.getBoundingClientRect();
  canvas.width = rect.width*dpr;
  canvas.height = rect.height*dpr;
  ctx.setTransform(dpr,0,0,dpr,0,0);
  updateWaypoints();
  
  $('canvasWidth').textContent = Math.round(canvas.width/dpr);
  $('canvasHeight').textContent = Math.round(canvas.height/dpr);
}

function updateWaypoints(){
  const w = canvas.width/dpr;
  const h = canvas.height/dpr;
  
  if(pathMode === 'straight') {
    waypoints = [
      {x: -40, y: h/2},
      {x: w + 40, y: h/2}
    ];
  } else if(pathMode === 'wave') {
    waypoints = [];
    const segments = 12;
    const segmentWidth = w / segments;
    
    for(let i = 0; i <= segments; i++) {
      const x = i * segmentWidth;
      const y = h/2 + Math.sin(i * 0.8) * (h/4);
      waypoints.push({x, y});
    }
    waypoints[0].x = -40;
    waypoints[waypoints.length-1].x = w + 40;
  } else if(pathMode === 'curve') {
    waypoints = [];
    const centerY = h/2;
    const amplitude = h/3;
    
    for(let i = 0; i <= 20; i++) {
      const progress = i / 20;
      const x = progress * w;
      const curve = Math.sin(progress * Math.PI);
      const y = centerY + curve * amplitude;
      waypoints.push({x, y});
    }
    waypoints[0].x = -40;
    waypoints[waypoints.length-1].x = w + 40;
  } else if(pathMode === 'zigzag') {
    waypoints = [];
    const segments = 6;
    const segmentWidth = w / segments;
    
    for(let i = 0; i <= segments; i++) {
      const x = i * segmentWidth;
      const y = h/2 + (i % 2 === 0 ? -h/4 : h/4);
      waypoints.push({x, y});
    }
    waypoints[0].x = -40;
    waypoints[waypoints.length-1].x = w + 40;
  }
}

function initGameControls() {
    // –í –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ–º —Ä–µ–∂–∏–º–µ –Ω–µ–ª—å–∑—è –º–µ–Ω—è—Ç—å –∫–∞—Ä—Ç—É
    if (gameMode === 'sandbox') {
        canChangeMap = false;
    } else {
        canChangeMap = false; // –í –∫–∞–º–ø–∞–Ω–∏–∏ —Ç–æ–∂–µ –Ω–µ–ª—å–∑—è
    }

    $('toggleRulerBtn').onclick = ()=>{
        rulerVisible = !rulerVisible;
        $('ruler').style.display = rulerVisible ? 'block' : 'none';
        $('toggleRulerBtn').textContent = rulerVisible ? 'üìè' : 'üìê';
    };

    canvas.addEventListener('mousemove', (e) => {
        const rect = canvas.getBoundingClientRect();
        mouseX = Math.round((e.clientX - rect.left) * (canvas.width / rect.width / dpr));
        mouseY = Math.round((e.clientY - rect.top) * (canvas.height / rect.height / dpr));
        $('mouseX').textContent = mouseX;
        $('mouseY').textContent = mouseY;
    });
}

// === Particle System ===
class Particle {
  constructor(x, y, color, size, velocity, life=1.0) {
    this.x = x;
    this.y = y;
    this.color = color;
    this.size = size;
    this.vx = velocity.x;
    this.vy = velocity.y;
    this.life = life;
    this.maxLife = life;
  }
  
  update(dt) {
    this.x += this.vx * dt;
    this.y += this.vy * dt;
    this.life -= dt;
    this.vx *= 0.98;
    this.vy *= 0.98;
    return this.life > 0;
  }
  
  draw() {
    const alpha = this.life / this.maxLife;
    ctx.save();
    ctx.globalAlpha = alpha;
    ctx.fillStyle = this.color;
    ctx.beginPath();
    ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
    ctx.fill();
    ctx.restore();
  }
}

function createExplosion(x, y, color, count=8) {
  for(let i = 0; i < count; i++) {
    const angle = Math.random() * Math.PI * 2;
    const speed = 50 + Math.random() * 100;
    particles.push(new Particle(
      x, y, color,
      2 + Math.random() * 4,
      {x: Math.cos(angle) * speed, y: Math.sin(angle) * speed},
      0.5 + Math.random() * 0.5
    ));
  }
}

// === Enemy ===
class Enemy{ 
  constructor(hp,speed,delay=0){ 
    this.hp=this.maxHp=hp; 
    this.speed=speed; 
    this.progress=0; 
    this.delay=delay; 
    this.alive=true; 
    this.r=12;
  }
  
  pos(){ 
    if(waypoints.length<2) return {x:0,y:0}; 
    const total = waypoints.reduce((s,p,i)=>i<waypoints.length-1?s+Math.hypot(waypoints[i+1].x-p.x,waypoints[i+1].y-p.y):s,0); 
    let d=this.progress*total; 
    for(let i=0;i<waypoints.length-1;i++){ 
      const len=Math.hypot(waypoints[i+1].x-waypoints[i].x,waypoints[i+1].y-waypoints[i].y); 
      if(d<=len){ 
        const r=d/len; 
        return {
          x:waypoints[i].x+(waypoints[i+1].x-waypoints[i].x)*r, 
          y:waypoints[i].y+(waypoints[i+1].y-waypoints[i].y)*r
        };
      } 
      d-=len; 
    } 
    return waypoints[waypoints.length-1]; 
  } 
  
  update(dt){ 
    if(this.delay>0){ 
      this.delay-=dt; 
      return; 
    }
    
    this.progress+=dt*this.speed/100; 
    const p=this.pos(); 
    this.x=p.x; 
    this.y=p.y; 
    if(this.progress>=1){ 
      this.alive=false; 
      lives=Math.max(0,lives-1); 
      updateUI(); 
      createExplosion(this.x, this.y, '#ff6b6b', 12);
      log('–í—Ä–∞–≥ –¥–æ—à—ë–ª! -1 –∂–∏–∑–Ω—å');
      if(lives <= 0) {
        showGameOver();
      }
    } 
  } 
  
  draw(){ 
    const grd = ctx.createRadialGradient(this.x,this.y,2,this.x,this.y,this.r*2); 
    grd.addColorStop(0,'rgba(255,110,110,0.95)'); 
    grd.addColorStop(0.6,'rgba(255,80,80,0.7)'); 
    grd.addColorStop(1,'rgba(255,40,40,0.05)'); 
    ctx.fillStyle=grd; 
    ctx.beginPath(); 
    ctx.arc(this.x,this.y,this.r,0,Math.PI*2); 
    ctx.fill(); 
    ctx.fillStyle='rgba(0,0,0,0.5)'; 
    ctx.fillRect(this.x-18,this.y-24,36,5); 
    ctx.fillStyle='#2ef27b'; 
    ctx.fillRect(this.x-18,this.y-24,36*(this.hp/this.maxHp),5); 
  } 
}

// === Tower ===
class Tower{ 
  constructor(x, y, name){ 
    this.x = x;
    this.y = y;
    this.name = name;
    this.range=170;
    this.reload=0;
    this.reloadTime=0.55;
    this.damage=40;
    this.level=1;
    this.color='#0ea5ff';
  }
  
  update(dt){ 
    this.reload-=dt; 
    if(this.reload<=0){ 
      let target=null,minD=this.range; 
      for(let e of enemies) if(e.alive){ 
        const d=Math.hypot(e.x-this.x,e.y-this.y); 
        if(d<minD){ 
          minD=d; 
          target=e;
        }
      } 
      if(target){ 
        bullets.push(new Bullet(this.x,this.y,target,this.damage));
        this.reload=this.reloadTime; 
      } 
    } 
  } 
  
  draw(){ 
    ctx.fillStyle=this.color; 
    ctx.beginPath(); 
    ctx.roundRect(this.x-22,this.y-22,44,44,6); 
    ctx.fill(); 
    ctx.strokeStyle=this.color + '20'; 
    ctx.lineWidth=3; 
    ctx.stroke(); 
    
    // Range indicator on hover
    if(Math.random() < 0.02) {
      ctx.strokeStyle = this.color + '15';
      ctx.setLineDash([5, 5]);
      ctx.beginPath();
      ctx.arc(this.x, this.y, this.range, 0, Math.PI * 2);
      ctx.stroke();
      ctx.setLineDash([]);
    }
    
    ctx.fillStyle='#00121a'; 
    ctx.font='11px monospace'; 
    ctx.textAlign='center'; 
    
    // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –∏–º—è –∏ —É—Ä–æ–≤–µ–Ω—å
    ctx.fillText(this.name, this.x, this.y-8); 
    ctx.fillText('L'+this.level, this.x, this.y+8); 
  } 
}

// === Bullet ===
class Bullet{ 
  constructor(x,y,t,d){ 
    this.x=x; 
    this.y=y; 
    this.t=t; 
    this.dmg=d; 
    this.speed=1000;
    this.color='#0ea5ff';
    this.size=5;
    this.alive=true; 
  } 
  
  update(dt){ 
    if(!this.t||!this.t.alive){ 
      this.alive=false; 
      return;
    } 
    const dx=this.t.x-this.x, dy=this.t.y-this.y, dist=Math.hypot(dx,dy); 
    if(dist<10){ 
      this.t.hp-=this.dmg; 
      createExplosion(this.t.x, this.t.y, this.color, 8);
      
      if(this.t.hp<=0){ 
        this.t.alive=false; 
        const reward = 10 + Math.floor(wave * 1.5);
        money+=reward; 
        score+=reward;
        kills++;
        updateUI(); 
      } 
      this.alive=false; 
      return;
    } 
    this.x+=dx/dist*this.speed*dt; 
    this.y+=dy/dist*this.speed*dt; 
  } 
  
  draw(){ 
    ctx.fillStyle=this.color; 
    ctx.beginPath(); 
    ctx.arc(this.x,this.y,this.size,0,Math.PI*2); 
    ctx.fill();
  } 
}

// === Game Logic ===
function spawn_wave(){ 
  wave++; 
  const cnt=5+wave*2;
  const hp=20+wave*2;
  const spd=25+wave*2;
  
  enemySpawnQueue = [];
  for(let i=0;i<cnt;i++){ 
    enemySpawnQueue.push({
      hp: hp,
      speed: spd,
      delay: i * 0.4
    });
  }
  
  lastSpawnTime = 0;
  updateUI(); 
  log(`üåÄ –í–æ–ª–Ω–∞ ${wave} (${cnt} –≤—Ä–∞–≥–æ–≤, HP: ${hp})`);
  
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–±–µ–¥—É –≤ –∫–∞–º–ø–∞–Ω–∏–∏
  if (gameMode === 'campaign' && wave >= requiredWaves) {
    setTimeout(() => {
      winCampaignLevel();
    }, 1000);
  }
}

function build_tower(name, x, y){ 
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≥—Ä–∞–Ω–∏—Ü—ã
  if(x < 0 || x > canvas.width/dpr || y < 0 || y > canvas.height/dpr) {
    log('‚ùå –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –∑–∞ –ø—Ä–µ–¥–µ–ª–∞–º–∏ –∫–∞—Ä—Ç—ã');
    return false;
  }
  
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å –∏–º–µ–Ω–∏
  if(towers.some(t => t.name === name)) {
    log(`‚ùå –ë–∞—à–Ω—è —Å –∏–º–µ–Ω–µ–º "${name}" —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç`);
    return false;
  }
  
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏–µ —Å –¥—Ä—É–≥–∏–º–∏ –±–∞—à–Ω—è–º–∏
  const minDistance = 60;
  for(let tower of towers) {
    const distance = Math.hypot(tower.x - x, tower.y - y);
    if(distance < minDistance) {
      log('‚ùå –°–ª–∏—à–∫–æ–º –±–ª–∏–∑–∫–æ –∫ –¥—Ä—É–≥–æ–π –±–∞—à–Ω–µ');
      return false;
    }
  }
  
  if(money < 50) {
    log('‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–µ–Ω–µ–≥. –ù—É–∂–Ω–æ: 50');
    return false;
  }
  
  towers.push(new Tower(x, y, name)); 
  money -= 50;
  towersBuilt++;
  updateUI(); 
  log(`üèóÔ∏è –ü–æ—Å—Ç—Ä–æ–µ–Ω–∞ –±–∞—à–Ω—è "${name}" –≤ (${x}, ${y}) (-50)`);
  return true;
}

function upgrade_tower(name){ 
  const t = towers.find(t => t.name === name);
  if(!t) {
    log(`‚ùå –ë–∞—à–Ω—è —Å –∏–º–µ–Ω–µ–º "${name}" –Ω–µ –Ω–∞–π–¥–µ–Ω–∞`);
    return false;
  }
  
  if(money<30) {
    log('‚ùå –ù—É–∂–Ω–æ 30 –¥–µ–Ω–µ–≥ –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è');
    return false;
  }
  
  t.level++; 
  t.damage+=15; 
  t.reloadTime*=0.9;
  t.range += 5;
  money-=30; 
  score += 5;
  upgradesDone++;
  updateUI(); 
  log(`‚ö° –£–ª—É—á—à–µ–Ω–∞ –±–∞—à–Ω—è "${name}" ‚Üí L${t.level} (+5 –∫ —Å—á–µ—Ç—É)`);
  return true;
}

function get_towers() {
  return towers.map(t => ({
    name: t.name,
    x: Math.round(t.x),
    y: Math.round(t.y),
    level: t.level,
    damage: t.damage,
    range: Math.round(t.range)
  }));
}

function reset_game(){ 
  enemies=[]; 
  bullets=[]; 
  towers=[]; 
  particles=[]; 
  enemySpawnQueue = [];
  
  // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–∞—á–∞–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–µ–∂–∏–º–∞
  if (gameMode === 'campaign') {
    const levelData = campaignLevels[currentCampaignLevel];
    lives = levelData.startingLives;
    money = levelData.startingMoney;
    requiredWaves = levelData.wavesToWin;
  } else {
    lives = 10;
    money = 100;
    requiredWaves = 0;
  }
  
  wave=0; 
  score=0;
  kills = 0;
  towersBuilt = 0;
  upgradesDone = 0;
  updateUI(); 
  hideGameOver();
  log('üîÑ –ò–≥—Ä–∞ —Å–±—Ä–æ—à–µ–Ω–∞');
}

function showGameOver() {
  $('finalWave').textContent = wave;
  $('finalScore').textContent = score;
  $('kills').textContent = kills;
  $('towersBuilt').textContent = towersBuilt;
  $('upgradesDone').textContent = upgradesDone;
  $('gameOver').style.display = 'flex';
  
  // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –¥–ª—è –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
  if (currentUser && currentUser.username !== '–ì–æ—Å—Ç—å') {
    if (gameMode === 'sandbox') {
      const isNewRecord = TD_DB.updateRecord(currentUser.username, currentMap, wave, score, kills);
      if (isNewRecord) {
        log('üéâ –ù–æ–≤—ã–π —Ä–µ–∫–æ—Ä–¥ –Ω–∞ —ç—Ç–æ–π –∫–∞—Ä—Ç–µ!');
      }
    }
  }
  
  const restartHandler = (e) => {
    returnToMenu();
    document.removeEventListener('keydown', restartHandler);
    document.removeEventListener('click', restartHandler);
  };
  
  document.addEventListener('keydown', restartHandler);
  document.addEventListener('click', restartHandler);
}

function winCampaignLevel() {
  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —ç–∫—Ä–∞–Ω –ø–æ–±–µ–¥—ã
  $('finalWave').textContent = wave;
  $('finalScore').textContent = score;
  $('kills').textContent = kills;
  $('towersBuilt').textContent = towersBuilt;
  $('upgradesDone').textContent = upgradesDone;
  
  // –ú–µ–Ω—è–µ–º —Ç–µ–∫—Å—Ç –Ω–∞ —ç–∫—Ä–∞–Ω–µ
  $('gameOver').innerHTML = `
    <div class="game-over-text" style="color: #2ef27b;">–ü–û–ë–ï–î–ê!</div>
    <div class="game-over-subtext">–£—Ä–æ–≤–µ–Ω—å ${currentCampaignLevel} –ø—Ä–æ–π–¥–µ–Ω!</div>
    <div class="game-over-stats">
      <div>–î–æ—Å—Ç–∏–≥–Ω—É—Ç–∞—è –≤–æ–ª–Ω–∞: <span id="finalWave">${wave}</span></div>
      <div>–°—á—ë—Ç: <span id="finalScore">${score}</span></div>
      <div>–£–±–∏—Ç–æ –≤—Ä–∞–≥–æ–≤: <span id="kills">${kills}</span></div>
    </div>
    <div class="game-over-subtext">${campaignLevels[currentCampaignLevel].rewards}</div>
    <div class="game-over-subtext pulse">–ù–∞–∂–º–∏—Ç–µ –ª—é–±—É—é –∫–Ω–æ–ø–∫—É –¥–ª—è –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è</div>
  `;
  $('gameOver').style.display = 'flex';
  
  // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å –∫–∞–º–ø–∞–Ω–∏–∏
  if (currentUser && currentUser.username !== '–ì–æ—Å—Ç—å') {
    const nextLevel = currentCampaignLevel + 1;
    if (nextLevel <= 5) {
      TD_DB.updateCampaignProgress(currentUser.username, nextLevel);
    }
  }
  
  const restartHandler = (e) => {
    returnToMenu();
    document.removeEventListener('keydown', restartHandler);
    document.removeEventListener('click', restartHandler);
  };
  
  document.addEventListener('keydown', restartHandler);
  document.addEventListener('click', restartHandler);
}

function hideGameOver() {
  $('gameOver').style.display = 'none';
}

// === Loop ===
let last=performance.now();
function update(dt){ 
  if(enemySpawnQueue.length > 0) {
    lastSpawnTime += dt;
    while(enemySpawnQueue.length > 0 && enemySpawnQueue[0].delay <= lastSpawnTime) {
      const enemyData = enemySpawnQueue.shift();
      enemies.push(new Enemy(enemyData.hp, enemyData.speed));
    }
  }
  
  enemies.forEach(e=>e.alive&&e.update(dt)); 
  towers.forEach(t=>t.update(dt)); 
  bullets.forEach(b=>b.alive&&b.update(dt)); 
  particles = particles.filter(p => p.update(dt));
  enemies=enemies.filter(e=>e.alive); 
  bullets=bullets.filter(b=>b.alive); 
}

function draw(){ 
  ctx.clearRect(0,0,canvas.width,canvas.height); 
  
  if(waypoints.length>=2){ 
    ctx.lineWidth=40; 
    ctx.lineCap='round'; 
    ctx.strokeStyle='rgba(46,242,123,0.08)'; 
    ctx.beginPath(); 
    ctx.moveTo(waypoints[0].x,waypoints[0].y); 
    for(let p of waypoints.slice(1)) ctx.lineTo(p.x,p.y); 
    ctx.stroke(); 
    
    ctx.lineWidth=4; 
    ctx.strokeStyle='rgba(46,242,123,0.3)'; 
    ctx.setLineDash([10, 10]);
    ctx.beginPath(); 
    ctx.moveTo(waypoints[0].x,waypoints[0].y); 
    for(let p of waypoints.slice(1)) ctx.lineTo(p.x,p.y); 
    ctx.stroke(); 
    ctx.setLineDash([]);
  } 
  
  particles.forEach(p=>p.draw());
  towers.forEach(t=>t.draw()); 
  enemies.forEach(e=>e.draw()); 
  bullets.forEach(b=>b.draw()); 
}

function loop(ts){ 
  const dt=Math.min((ts-last)/1000, 0.1); 
  last=ts; 
  update(dt); 
  draw(); 
  requestAnimationFrame(loop);
}

function startGame() {
    document.getElementById('mainMenu').style.display = 'none';
    document.querySelector('.container').style.display = 'flex';
    
    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–∞—Ä—Ç—É –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–µ–∂–∏–º–∞
    if (gameMode === 'sandbox') {
        document.getElementById('gameTitle').textContent = `‚àû –ë–µ—Å–∫–æ–Ω–µ—á–Ω—ã–π —Ä–µ–∂–∏–º: ${getMapName(currentMap)}`;
        pathMode = currentMap;
    } else {
        const levelData = campaignLevels[currentCampaignLevel];
        document.getElementById('gameTitle').textContent = levelData.title;
        pathMode = levelData.map;
    }
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∏–≥—Ä—É
    resizeCanvas();
    initGameControls();
    updateWaypoints();
    reset_game();
    gameStartTime = Date.now();
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–ø–∏—Å–∞–Ω–∏–µ —É—Ä–æ–≤–Ω—è –≤ –∫–∞–º–ø–∞–Ω–∏–∏
    if (gameMode === 'campaign') {
        setTimeout(() => {
            showLevelDescription();
        }, 500);
    }
    
    window.addEventListener('resize', resizeCanvas);
    requestAnimationFrame(loop);
}

// ============================================
// –†–ï–î–ê–ö–¢–û–† –ö–û–î–ê (–ü–û–õ–ù–û–°–¢–¨–Æ –ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ô)
// ============================================
let editor = null;
let pyodideReady = false, pyodide;

function initEditor() {
    const editorContainer = document.getElementById('editor');
    editorContainer.innerHTML = '';
    
    // –°–æ–∑–¥–∞–µ–º –ø—É—Å—Ç–æ–π —Ä–µ–¥–∞–∫—Ç–æ—Ä –ë–ï–ó –ø–æ–¥—Å–∫–∞–∑–∫–∏
    editor = CodeMirror(editorContainer, {
        mode: 'python',
        theme: 'dracula',
        lineNumbers: true,
        lineWrapping: false,
        indentUnit: 4,
        tabSize: 4,
        indentWithTabs: false,
        electricChars: true,
        matchBrackets: true,
        autoCloseBrackets: true,
        styleActiveLine: true,
        showCursorWhenSelecting: true,
        cursorBlinkRate: 530,
        value: '', // –ü–£–°–¢–û–ô —Ä–µ–¥–∞–∫—Ç–æ—Ä –±–µ–∑ –ø–æ–¥—Å–∫–∞–∑–æ–∫
        gutters: ["CodeMirror-linenumbers"],
        extraKeys: {
            "Ctrl-Enter": function() { runCode(); },
            "Cmd-Enter": function() { runCode(); },
            "Tab": function(cm) {
                if (cm.somethingSelected()) {
                    cm.indentSelection("add");
                } else {
                    cm.replaceSelection("    ", "end");
                }
            },
            "Shift-Tab": function(cm) {
                cm.indentSelection("subtract");
            }
        }
    });
    
    // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞
    editor.setSize("100%", "100%");
    
    // –§–æ–∫—É—Å –Ω–∞ —Ä–µ–¥–∞–∫—Ç–æ—Ä
    setTimeout(() => {
        editor.focus();
        editor.refresh();
    }, 100);
}

async function loadPyodideAndPackages(){ 
    try {
        pyodide = await loadPyodide(); 
        pyodideReady = true; 
        log("‚úÖ Python –≥–æ—Ç–æ–≤ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é!"); 
    } catch (error) {
        log("‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ Python: " + error.message);
    }
}

async function runCode(){
    if(!pyodideReady){ 
        log("‚è≥ Python –µ—â—ë –Ω–µ –≥–æ—Ç–æ–≤..."); 
        return; 
    }
    
    const code = editor.getValue();
    if (!code.trim()) {
        log("‚ÑπÔ∏è –í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è");
        return;
    }
    
    try {
        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
        pyodide.globals.set("build_tower", build_tower);
        pyodide.globals.set("upgrade_tower", upgrade_tower);
        pyodide.globals.set("spawn_wave", spawn_wave);
        pyodide.globals.set("reset_game", reset_game);
        pyodide.globals.set("get_towers", get_towers);
        
        // –í—ã–ø–æ–ª–Ω—è–µ–º –∫–æ–¥
        await pyodide.runPythonAsync(code);
        log("‚úÖ –ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ!");
    } catch(e) { 
        log(`‚ùå –û—à–∏–±–∫–∞: ${e.message}`);
    }
}

// Tab switching functionality
function switchTab(tabName) {
    document.querySelectorAll('.tab').forEach(tab => {
        tab.classList.toggle('active', tab.dataset.tab === tabName);
    });
    
    const editorEl = $('editor');
    const guidePanel = $('guidePanel');
    
    if (tabName === 'editor') {
        editorEl.style.display = 'block';
        guidePanel.classList.remove('active');
        // –§–æ–∫—É—Å –Ω–∞ —Ä–µ–¥–∞–∫—Ç–æ—Ä –ø—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏
        if (editor) {
            setTimeout(() => {
                editor.focus();
                editor.refresh();
            }, 50);
        }
    } else {
        editorEl.style.display = 'none';
        guidePanel.classList.add('active');
    }
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Å–æ–±—ã—Ç–∏–π –¥–ª—è —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞
function initEditorHandlers() {
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –≤–∫–ª–∞–¥–æ–∫
    document.querySelectorAll('.tab').forEach(tab => {
        tab.addEventListener('click', () => {
            switchTab(tab.dataset.tab);
        });
    });
    
    // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–Ω–æ–ø–æ–∫
    if ($('runBtn')) {
        $('runBtn').onclick = runCode;
    }
    
    if ($('clearConsoleBtn')) {
        $('clearConsoleBtn').onclick = () => {
            $('console').innerHTML = '';
            log("üóëÔ∏è –ö–æ–Ω—Å–æ–ª—å –æ—á–∏—â–µ–Ω–∞");
        };
    }
    
    if ($('resetBtn')) {
        $('resetBtn').onclick = reset_game;
    }
    
    if ($('menuBtn')) {
        $('menuBtn').onclick = returnToMenu;
    }
    
    // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –≥–æ—Ä—è—á–∏–µ –∫–ª–∞–≤–∏—à–∏
    document.addEventListener('keydown', e=>{ 
        if(e.ctrlKey && e.key==='Enter') {
            e.preventDefault();
            runCode(); 
        }
    });
}

// ============================================
// –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ü–†–ò –ó–ê–ì–†–£–ó–ö–ï
// ============================================
document.addEventListener('DOMContentLoaded', () => {
    TD_DB.init();
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
    const savedUser = sessionStorage.getItem('td_current_user');
    if (savedUser) {
        currentUser = JSON.parse(savedUser);
        showMainMenu();
    } else {
        showLogin();
    }
    
    // –ó–∞–≥—Ä—É–∂–∞–µ–º Pyodide
    loadPyodideAndPackages();
});

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ –∏–≥—Ä—ã
function initGameUI() {
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Ä–µ–¥–∞–∫—Ç–æ—Ä –µ—Å–ª–∏ –µ—â–µ –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω
    if (!editor) {
        setTimeout(() => {
            initEditor();
        }, 100);
    }
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
    initEditorHandlers();
}

// –û–±–Ω–æ–≤–ª—è–µ–º startGame –¥–ª—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ UI
const originalStartGame = startGame;
startGame = function() {
    originalStartGame();
    setTimeout(() => {
        initGameUI();
    }, 100);
};

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Ä–µ–¥–∞–∫—Ç–æ—Ä –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
const observer = new MutationObserver(function(mutations) {
    mutations.forEach(function(mutation) {
        if (mutation.type === 'attributes' && mutation.attributeName === 'style') {
            const container = document.querySelector('.container');
            if (container && container.style.display !== 'none' && !editor) {
                setTimeout(() => {
                    initEditor();
                    initEditorHandlers();
                }, 200);
            }
        }
    });
});

// –ù–∞—á–∏–Ω–∞–µ–º –Ω–∞–±–ª—é–¥–µ–Ω–∏–µ –∑–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–º
const container = document.querySelector('.container');
if (container) {
    observer.observe(container, {
        attributes: true,
        attributeFilter: ['style']
    });
}
</script>
</body>
</html>